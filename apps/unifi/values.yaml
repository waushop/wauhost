---
# Production values for UniFi Controller at unifi.waushop.ee

image:
  repository: jacobalberty/unifi
  tag: "v7.1.68"
  pullPolicy: IfNotPresent

# Resources optimized for Hetzner cluster
resources:
  requests:
    memory: 1Gi
    cpu: 500m
  limits:
    memory: 2Gi
    cpu: 1000m

# Persistence with FREE Longhorn storage
persistence:
  data:
    enabled: true
    size: 20Gi
    storageClass: longhorn
    accessMode: ReadWriteOnce

# Service configuration (NO LoadBalancer costs)
service:
  main:
    type: ClusterIP
  udp:
    enabled: false  # Disable UDP LoadBalancer to save â‚¬5/month
    # Can enable later if device discovery issues occur

# Ingress for unifi.waushop.ee
ingress:
  main:
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    hosts:
      - host: unifi.waushop.ee
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: unifi-waushop-tls
        hosts:
          - unifi.waushop.ee

# Environment variables
env:
  TZ: "Europe/Tallinn"
  RUNAS_UID0: "false"
  UNIFI_UID: "999"
  UNIFI_GID: "999"
  JVM_INIT_HEAP_SIZE: "512M"
  JVM_MAX_HEAP_SIZE: "1024M"
  UNIFI_STDOUT: "true"

# Node selector for Hetzner nodes
nodeSelector:
  kubernetes.io/os: linux

# Affinity to spread pods
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - unifi
        topologyKey: kubernetes.io/hostname

# Probes configuration
livenessProbe:
  httpGet:
    path: /status
    port: 8080
  initialDelaySeconds: 300
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /status
    port: 8080
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /status
    port: 8080
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 20

# Security context
podSecurityContext:
  fsGroup: 999
  runAsNonRoot: true
  runAsUser: 999
  runAsGroup: 999

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 999
  runAsGroup: 999